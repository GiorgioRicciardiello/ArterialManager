# ðŸ§  Interpretation Guide: Vessel Colocalization Metrics

This document explains the meaning of each metric generated by the **vessel colocalization pipeline**.
Metrics are grouped by **category**: *intensity-based*, *binary*, and *absolute/structural*.
Values typically range between 0 and 1 unless noted otherwise.

---

## ðŸ”¸ Intensity-Based Metrics

These metrics evaluate colocalization using **continuous intensity values**, capturing how strongly and where red and green vessels overlap in signal strength.

| Metric                | Meaning                                                   | Interpretation                                                               |
| --------------------- | --------------------------------------------------------- | ---------------------------------------------------------------------------- |
| **Manders_M1**        | Fraction of **green intensity overlapping red**.          | `M1 = Î£(G where R>0)/Î£(G)`. High â†’ most green lies on red.                   |
| **Manders_M2**        | Fraction of **red intensity overlapping green**.          | `M2 = Î£(R where G>0)/Î£(R)`. High â†’ most red lies on green.                   |
| **Pearson**           | Correlation of intensity variation in overlapping pixels. | Measures how pixel intensities covary. 1 â†’ linear match, 0 â†’ uncorrelated.   |
| **Dice_skeletons**    | Structural overlap of green vs red vessel skeletons.      | 1 â†’ identical skeletons; 0 â†’ no overlap.                                     |
| **Jaccard_skeletons** | Intersection-over-union of skeletons.                     | More conservative than Dice; smaller values.                                 |
| **sum_heatmap**       | Raw summed intensity overlap.                             | Absolute signal strength in overlapped regions.                              |
| **frac_heatmap**      | Normalized intensity overlap fraction.                    | Fraction of vessel area where signals overlap. Higher = more colocalization. |

**Use case:** Quantify **signal-based colocalization strength** â€” good for evaluating staining coincidence or fluorophore alignment.

---

## ðŸ”¹ Binary Metrics

Binary metrics use thresholded images (vessel present or not) to describe **spatial co-occurrence** â€” independent of brightness.

| Metric                         | Meaning                                           | Interpretation                                       |
| ------------------------------ | ------------------------------------------------- | ---------------------------------------------------- |
| **Manders_M1 (binary)**        | Fraction of green pixels overlapping red pixels.  | Purely spatial (0â€“1).                                |
| **Manders_M2 (binary)**        | Fraction of red pixels overlapping green pixels.  | Higher â†’ red structures lie mainly on green vessels. |
| **Pearson (binary)**           | Correlation of presence/absence between channels. | Values near 0 â†’ weak spatial relationship.           |
| **Dice_skeletons (binary)**    | Structural overlap between binary skeletons.      | Similar to the intensity version.                    |
| **Jaccard_skeletons (binary)** | Area intersection/union of binary skeletons.      | Stricter spatial overlap measure.                    |
| **sum_heatmap (binary)**       | Total count of overlapped pixels.                 | Raw overlap area (in pixels).                        |
| **frac_heatmap (binary)**      | Fraction of total vessel area overlapped.         | Fraction of red/green pixels co-located.             |

**Use case:** Captures **where** vessels overlap, ignoring how bright they are.
Ideal for geometric or segmentation-based analysis.

---

## âš™ï¸ Absolute / Structural / Information Metrics

These describe **signal strength**, **network topology**, and **information overlap**, used to assess alignment and morphology.

### Signal & Intensity Metrics

| Metric                               | Meaning                                   | Interpretation                            |
| ------------------------------------ | ----------------------------------------- | ----------------------------------------- |
| **g_norm_abs / pct**                 | Total or mean normalized green intensity. | Channel brightness before cleaning.       |
| **g_clean_abs / pct**                | After WBNS background subtraction.        | Shows improvement in signal contrast.     |
| **r_norm_abs / pct**                 | Total or mean normalized red intensity.   | Red signal before cleaning.               |
| **r_clean_abs / pct**                | Red signal after background removal.      |                                           |
| **g_v_abs / pct**, **r_v_abs / pct** | Vesselness-filtered intensity (Frangi).   | Strength of vessel-like structures.       |
| **green_red_ratio**                  | Ratio of total green / red intensity.     | >1 â†’ green dominates; <1 â†’ red dominates. |
| **red_green_ratio**                  | Inverse ratio (redundant view).           | >1 â†’ red dominates.                       |

---

### Structural Overlap & Distances

| Metric                              | Meaning                                | Interpretation                                     |
| ----------------------------------- | -------------------------------------- | -------------------------------------------------- |
| **sum_overlap_strength**            | Sum of all overlapping intensities.    | Global overlap magnitude (unnormalized).           |
| **sum_vessel_mask**                 | Total vessel area (pixels).            | Baseline area for normalization.                   |
| **sum_near_overlap**                | Pixel-perfect overlap of skeletons.    | Count of directly coincident vessel pixels.        |
| **sum_heatmap_intensity / binary**  | Raw overlap energy or area.            | Used for normalization ratios.                     |
| **sum_overlay**                     | Sum of all RGB overlay values.         | Overall image brightness (diagnostic).             |
| **frac_heatmap_intensity / binary** | Fraction of vessel area that overlaps. | 0â€“1, higher means stronger overlap.                |
| **weighted_overlap_green**          | Fraction of green intensity on red.    | Red signal coverage of green (intensity-weighted). |
| **weighted_overlap_red**            | Fraction of red intensity on green.    | Primary indicator of â€œhow much red is on green.â€   |
| **weighted_overlap_mean**           | Symmetric average of both.             | Overall bidirectional colocalization fraction.     |

---

### Correlation & Information Metrics

| Metric                  | Meaning                                              | Interpretation                                   |
| ----------------------- | ---------------------------------------------------- | ------------------------------------------------ |
| **cosine_similarity**   | Shape similarity between green & red intensity maps. | 1 â†’ identical patterns, 0 â†’ unrelated.           |
| **bhattacharyya_coeff** | Histogram overlap between intensity distributions.   | Higher â†’ similar global intensity distributions. |
| **hellinger_distance**  | Statistical distance between histograms.             | Lower â†’ more similar intensity profiles.         |
| **mutual_information**  | Shared information between green & red intensity.    | Higher â†’ stronger nonlinear dependency.          |
| **icq**                 | Liâ€™s Intensity Correlation Quotient.                 | âˆ’0.5 â†’ segregated, +0.5 â†’ highly colocalized.    |

---

### Detection-Style Metrics (Binary Overlap as Classification)

| Metric        | Meaning                                                      | Interpretation                        |
| ------------- | ------------------------------------------------------------ | ------------------------------------- |
| **precision** | Fraction of red pixels on green (TP / all red).              | How much red lies on green.           |
| **recall**    | Fraction of green pixels overlapped by red (TP / all green). | How much green is covered by red.     |
| **f1**        | Harmonic mean of precision and recall.                       | Overall spatial matching performance. |

---

### Skeleton Geometry Metrics

| Metric                                             | Meaning                                  | Interpretation                                      |
| -------------------------------------------------- | ---------------------------------------- | --------------------------------------------------- |
| **assd_skeleton**                                  | Average symmetric surface distance (px). | Lower = better alignment of vessel skeletons.       |
| **hausdorff_skeleton**                             | Maximum distance between skeletons (px). | Measures largest spatial deviation.                 |
| **g_skel_len_abs / pct**, **r_skel_len_abs / pct** | Skeletonized vessel lengths.             | Network extent per channel.                         |
| **skel_overlap_len_abs / pct**                     | Overlapped skeleton length.              | Shared vessel segments.                             |
| **g_endpoints / r_endpoints**                      | Number of vessel termini.                | Network branching or fragmentation.                 |
| **g_branchpoints / r_branchpoints**                | Number of junctions.                     | Structural complexity; higher = denser vasculature. |

---

## ðŸ§© Summary: Interpreting the Key Questions

| Biological Question                                           | Metric(s) to Use                                                             | Interpretation                                                      |
| ------------------------------------------------------------- | ---------------------------------------------------------------------------- | ------------------------------------------------------------------- |
| **How much red signal lies on green vessels?**                | `Manders_M2`, `weighted_overlap_red`, `precision`                            | Fraction of red intensity or area coinciding with green.            |
| **How well do red and green structures align geometrically?** | `Dice_skeletons`, `Jaccard_skeletons`, `assd_skeleton`, `hausdorff_skeleton` | Higher Dice/Jaccard, lower distances = better structural alignment. |
| **Are both channels similarly bright or biased?**             | `green_red_ratio`, `red_green_ratio`                                         | Values near 1 â†’ balanced staining.                                  |
| **Do their intensity patterns correlate?**                    | `Pearson`, `cosine_similarity`, `mutual_information`, `icq`                  | Higher = more correlated intensity variation.                       |
| **How extensive is the vessel network?**                      | `*_skel_len_*`, `*_branchpoints`, `*_endpoints`                              | Quantifies network density and complexity.                          |

---

**Interpretation tip:**

* **Values near 1** â†’ strong overlap or similarity.
* **Values near 0** â†’ independent or poorly aligned channels.
* **Distance metrics** (`assd`, `hausdorff`) â†’ *smaller is better*.
* Always interpret intensity-based metrics in the context of channel balance (`green_red_ratio`) to avoid bias from exposure differences.


---
Yes â€” many more **quantitative overlap metrics** are used in biomedical and medical-imaging research to describe *how two spatial distributions coincide*.
Your current function covers the â€œcore five,â€ but you can expand it with deterministic, interpretable measures grouped below.

---

## ðŸ©¸ 1. Area-based overlap extensions (set-theoretic)

| Metric                                        | Formula                                          | Interpretation                                 | Typical Range |     |     |                                              |      |                                                                                          |     |
| --------------------------------------------- | ------------------------------------------------ | ---------------------------------------------- | ------------- | --- | --- | -------------------------------------------- | ---- | ---------------------------------------------------------------------------------------- | --- |
| **Overlap Coefficient (Szymkiewiczâ€“Simpson)** | ( \frac{                                         | Aâˆ©B                                            | }{\min(       | A   | ,   | B                                            | )} ) | Fraction of the smaller region overlapped by the other. Robust when vessel areas differ. | 0â€“1 |
| **Tanimoto Coefficient**                      | ( \frac{Aâ‹…B}{|A|^2 + |B|^2 - Aâ‹…B} )              | Continuous version of Jaccard for intensities. | 0â€“1           |     |     |                                              |      |                                                                                          |     |
| **Volume Similarity (VS)**                    | ( 1 - \frac{                                     | A-B                                            | }{            | A+B | } ) | Balance between the two regionsâ€™ total size. | âˆ’1â€“1 |                                                                                          |     |
| **Mean Surface Overlap (MSO)**                | Average of overlap between dilated vessel edges. | Geometric tolerance-aware overlap.             | 0â€“1           |     |     |                                              |      |                                                                                          |     |

---

## âš™ï¸ 2. Intensity-weighted or correlation-based extensions

| Metric                                  | Description                                                                                | Advantage                                                                    |
| --------------------------------------- | ------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------- |
| **Spearman rank correlation**           | Non-linear monotonic correlation of intensities (less sensitive to outliers than Pearson). | Detects monotonic but non-linear dependencies.                               |
| **Normalized Mutual Information (NMI)** | ( NMI = \frac{H(A) + H(B)}{H(A,B)} )                                                       | Standardized information-theoretic overlap; used in multimodal registration. |
| **Structural Similarity Index (SSIM)**  | From `skimage.metrics.structural_similarity`; compares local contrast and luminance.       | Captures perceptual similarity between red and green patterns.               |
| **Overlap Energy (OE)**                 | ( \frac{\sum (AÂ·B)}{\sqrt{\sum A^2 \sum B^2}} )                                            | Cosine similarity for image overlap, equivalent to vector alignment.         |

---

## ðŸ§¬ 3. Morphometric / skeleton-aware overlap

| Metric                                | Formula / Idea                                        | Interpretation                                           |    |          |     |                                                            |
| ------------------------------------- | ----------------------------------------------------- | -------------------------------------------------------- | -- | -------- | --- | ---------------------------------------------------------- |
| **Skeleton Coverage Ratio (SCR)**     | ( \frac{                                              | R_{skel} âˆ© Dil(G_{skel},r)                               | }{ | R_{skel} | } ) | Fraction of red skeleton within r-pixel of green skeleton. |
| **Centerline Distance Mean (CLD)**    | Mean minimal distance between centerlines.            | Geometric alignment metric, like ASSD but for skeletons. |    |          |     |                                                            |
| **Branch Correspondence Score (BCS)** | Ratio of matching branch endpoints / total endpoints. | Topological alignment of vascular trees.                 |    |          |     |                                                            |

---

## ðŸ§© 4. Example â€” add to your function

Hereâ€™s how to extend `_compute_overlap_metrics` deterministically with several of these:

```python
def _compute_overlap_metrics(G, R, g_skel, r_skel, mask_overlap, vessel_mask, label="intensity"):
    m1, m2 = _manders_coeffs(G.astype(np.float32),
                             R.astype(np.float32),
                             mask_overlap.astype(np.float32))

    pearson = (np.corrcoef(G[mask_overlap > 0].ravel(),
                           R[mask_overlap > 0].ravel())[0, 1]
               if mask_overlap.sum() > 10 else np.nan)

    # Binary intersections
    inter = np.logical_and(g_skel, r_skel).sum()
    union = np.logical_or(g_skel, r_skel).sum() + 1e-8
    dice = 2 * inter / (g_skel.sum() + r_skel.sum() + 1e-8)
    jaccard = inter / union
    overlap_coeff = inter / (min(g_skel.sum(), r_skel.sum()) + 1e-8)
    volume_similarity = 1 - abs(g_skel.sum() - r_skel.sum()) / (g_skel.sum() + r_skel.sum() + 1e-8)

    # Intensity Tanimoto
    numerator = np.sum(G * R)
    tanimoto = numerator / (np.sum(G**2) + np.sum(R**2) - numerator + 1e-8)

    return {
        f"Manders_M1_{label}": m1,
        f"Manders_M2_{label}": m2,
        f"Pearson_{label}": float(pearson),
        f"Dice_skeletons_{label}": dice,
        f"Jaccard_skeletons_{label}": jaccard,
        f"OverlapCoeff_{label}": overlap_coeff,
        f"VolumeSimilarity_{label}": volume_similarity,
        f"Tanimoto_{label}": tanimoto
    }
```

---

## ðŸ§  Summary â€” best additional metrics

| Category                  | Metric                                 | Why add it                                  |
| ------------------------- | -------------------------------------- | ------------------------------------------- |
| **Binary**                | Overlap coefficient, Volume similarity | Robust when area sizes differ               |
| **Intensity**             | Tanimoto, SSIM, Spearman               | Capture non-linear or perceptual similarity |
| **Geometry**              | Skeleton coverage, Centerline distance | Reflect vessel path alignment               |
| **Information-theoretic** | NMI, Mutual information                | Quantify shared intensity information       |

Adding 2â€“3 from each class gives a publication-level set of **â‰ˆ15 overlap descriptors**â€”covering spatial, intensity, and topological coincidence comprehensively.
